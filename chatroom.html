<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chat Room</title>
<style>
/* Your CSS styles */
body {
    font-family: Arial, sans-serif;
    background-color: #f4f4f4;
    margin: 0;
    padding: 0;
}

#chat-container {
    max-width: 800px;
    margin: 50px auto;
    padding: 20px;
    background-color: #fff;
    border-radius: 8px;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
}

h1 {
    font-size: 24px;
    text-align: center;
    margin-bottom: 20px;
}

#message-area {
    height: 300px;
    overflow-y: auto;
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 4px;
}

#message-area p {
    margin: 5px 0;
}

#input-area {
    margin-top: 20px;
    display: flex;
    justify-content: space-between;
}

#message-input {
    flex: 1;
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 4px;
}

#send-btn {
    padding: 10px 20px;
    background-color: #007bff;
    color: #fff;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 16px;
}

#send-btn:hover {
    background-color: #0056b3;
}

#change-username-btn {
    padding: 10px 20px;
    background-color: #28a745;
    color: #fff;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 16px;
}

#change-username-btn:hover {
    background-color: #218838;
}

#delete-account-btn {
    padding: 10px 20px;
    background-color: #dc3545;
    color: #fff;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 16px;
}

#delete-account-btn:hover {
    background-color: #c82333;
}
</style>
</head>
<body>
<div id="chat-container">
    <h1>Welcome to the Chat Room!</h1>
    <div id="message-area">
        <!-- Messages will be displayed here -->
    </div>
    <div id="input-area">
        <input type="text" id="message-input" placeholder="Type your message..." autocomplete="off">
        <input type="submit" value="Send" id="send-btn">
    </div>
    <!-- Add the "Change Username" button -->
    <div id="change-username-container">
        <button id="change-username-btn">Change Username</button>
    </div>
    <!-- Add the "Delete Account" button -->
    <div id="delete-account-container">
        <button id="delete-account-btn">Delete Account</button>
    </div>
</div>

<script type="module">
  // Import the necessary functions from the Firebase SDKs
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
  import { getFirestore, collection, addDoc, serverTimestamp, onSnapshot, query, orderBy, where, getDocs, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";
  import { getAuth, onAuthStateChanged, deleteUser } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";

  // Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyAW2PdNo9Ovq58XMH8f4GxWyeToBeqkokM",
    authDomain: "database-88dbf.firebaseapp.com",
    projectId: "database-88dbf",
    storageBucket: "database-88dbf.appspot.com",
    messagingSenderId: "376149256202",
    appId: "1:376149256202:web:54f0c628fe64ef5fe817f3",
    measurementId: "G-BW9YXL56YM"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  // Get the currently authenticated user
  let currentUser;
  onAuthStateChanged(auth, (user) => {
    if (user) {
      currentUser = user;
      loadUsername(user.uid); // Load username when user is authenticated
    } else {
      currentUser = null;
    }
  });

  // Function to load the username
  async function loadUsername(userId) {
    const userQuery = query(collection(db, "usernames"), where("userId", "==", userId));
    const querySnapshot = await getDocs(userQuery);
    querySnapshot.forEach((doc) => {
      const username = doc.data().username;
      document.getElementById("change-username-btn").textContent = "Change Username (" + username + ")";
    });
  }

  // Function to display messages in real-time
  const messageArea = document.getElementById("message-area");
  const queryMessages = query(collection(db, "messages"), orderBy("timestamp", "asc"));
  onSnapshot(queryMessages, (snapshot) => {
    snapshot.docChanges().forEach((change) => {
      if (change.type === "added") {
        const messageData = change.doc.data();
        const messageElement = document.createElement("p");
        messageElement.textContent = `${messageData.username}: ${messageData.message}`;
        messageArea.appendChild(messageElement);
        messageArea.scrollTop = messageArea.scrollHeight; // Scroll to bottom
      }
    });
  });

  // Add event listener for sending messages
  document.getElementById("send-btn").addEventListener("click", async () => {
    const message = document.getElementById("message-input").value;

    try {
      if (currentUser) {
        // Add message to Firestore
        await addDoc(collection(db, "messages"), {
          message: message,
          username: currentUser.displayName,
          timestamp: serverTimestamp()
        });

        // Clear message input field
        document.getElementById("message-input").value = "";
      } else {
        console.error("No user signed in.");
      }
    } catch (error) {
      console.error("Error adding message: ", error);
    }
  });

  // Add event listener for "Change Username" button
  document.getElementById("change-username-btn").addEventListener("click", async () => {
    const newUsername = prompt("Enter your new username:");
    if (newUsername !== null && newUsername.trim() !== "") {
      try {
        if (currentUser) {
          // Update the username
          await currentUser.updateProfile({
            displayName: newUsername
          });
          // Update the username in Firestore
          await loadUsername(currentUser.uid);
          alert("Username changed successfully!");
        } else {
          console.error("No user signed in.");
        }
      } catch (error) {
        console.error("Error changing username:", error);
      }
    }
  });

  // Add event listener for "Delete Account" button
  document.getElementById("delete-account-btn").addEventListener("click", async () => {
    if (confirm("Are you sure you want to delete your account? This action cannot be undone.")) {
      try {
        if (currentUser) {
          // Delete user's Firestore document
          await deleteDoc(doc(db, "usernames", currentUser.uid));

          // Delete user's account
          await deleteUser(auth.currentUser);
          alert("Your account has been deleted successfully.");
          window.location.href = "signup.html"
        } else {
          console.error("No user signed in.");
        }
      } catch (error) {
        console.error("Error deleting account:", error);
      }
    }
  });
</script>
</body>
</html>
